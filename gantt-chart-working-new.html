<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Charts - AI PPM Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f8fafc; }
        .gradient-text { background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar { background: #1e293b; height: 100vh; position: fixed; width: 250px; left: 0; top: 0; }
        .main-content { margin-left: 250px; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .nav-item { padding: 12px 20px; color: #94a3b8; transition: all 0.3s ease; cursor: pointer; border-radius: 8px; margin: 4px 12px; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #3b82f6; color: white; }
        .gantt-container { background: white; border-radius: 8px; overflow: hidden; }
        .gantt-header { background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 16px; }
        .gantt-timeline { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .gantt-timeline-cell { flex: 1; text-align: center; padding: 8px; font-size: 12px; color: #64748b; border-right: 1px solid #e2e8f0; }
        .gantt-row { display: flex; border-bottom: 1px solid #e2e8f0; min-height: 60px; align-items: center; }
        .gantt-task-info { width: 300px; padding: 12px; border-right: 1px solid #e2e8f0; background: white; }
        .gantt-timeline-area { flex: 1; position: relative; }
        .gantt-bar { position: absolute; height: 36px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 4px; top: 12px; cursor: move; transition: all 0.3s ease; display: flex; align-items: center; padding: 0 12px; color: white; font-size: 12px; font-weight: 600; }
        .gantt-bar:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .gantt-bar.completed { background: linear-gradient(135deg, #10b981, #059669); }
        .gantt-bar.at-risk { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .gantt-bar.delayed { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1001; display: none; }
        .notification.success { border-left: 4px solid #10b981; }
        .notification.error { border-left: 4px solid #ef4444; }
        .notification.info { border-left: 4px solid #3b82f6; }
        .view-controls { display: flex; gap: 8px; margin-bottom: 20px; }
        .view-btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; border: 1px solid #e2e8f0; background: white; }
        .view-btn:hover { border-color: #3b82f6; color: #3b82f6; }
        .view-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .milestone { position: absolute; width: 20px; height: 20px; background: #f59e0b; border-radius: 50%; top: 20px; transform: translateX(-50%); cursor: pointer; }
        .milestone:hover { transform: translateX(-50%) scale(1.2); }
        .today-line { position: absolute; width: 2px; background: #ef4444; top: 0; bottom: 0; z-index: 10; }
        .today-label { position: absolute; top: -20px; left: 4px; background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-white">AI PPM Pro</h1>
        </div>
        <nav class="px-4">
            <div class="nav-item" onclick="navigateTo('dashboard')">
                <i class="fas fa-dashboard mr-3"></i>Dashboard
            </div>
            <div class="nav-item" onclick="navigateTo('projects')">
                <i class="fas fa-project-diagram mr-3"></i>Projects
            </div>
            <div class="nav-item active" onclick="navigateTo('gantt')">
                <i class="fas fa-chart-gantt mr-3"></i>Gantt Charts
            </div>
            <div class="nav-item" onclick="navigateTo('resources')">
                <i class="fas fa-users-cog mr-3"></i>Resources
            </div>
            <div class="nav-item" onclick="navigateTo('risks')">
                <i class="fas fa-shield-alt mr-3"></i>Risk Management
            </div>
            <div class="nav-item" onclick="navigateTo('reports')">
                <i class="fas fa-file-chart-line mr-3"></i>Reports
            </div>
            <div class="nav-item" onclick="navigateTo('ai')">
                <i class="fas fa-brain mr-3"></i>AI Analysis
            </div>
        </nav>
        <div class="absolute bottom-6 left-6 right-6">
            <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Interactive Gantt Charts</h1>
                <p class="text-gray-600">Visualize project timelines with drag-and-drop functionality.</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="exportGantt()" class="btn btn-secondary">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
                <button onclick="showTaskModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Add Task
                </button>
            </div>
        </div>

        <!-- Project Selector -->
        <div class="card mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Project</label>
                    <select id="projectSelector" class="form-input md:w-96" onchange="loadProject()">
                        <option value="">Choose a project...</option>
                    </select>
                </div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Drag tasks to reschedule, click to edit details
                </div>
            </div>
        </div>

        <!-- View Controls -->
        <div class="view-controls">
            <button class="view-btn active" onclick="changeView('month')">Month View</button>
            <button class="view-btn" onclick="changeView('quarter')">Quarter View</button>
            <button class="view-btn" onclick="changeView('year')">Year View</button>
            <button class="view-btn" onclick="toggleCriticalPath()">
                <i class="fas fa-route mr-1"></i>Critical Path
            </button>
            <button class="view-btn" onclick="toggleMilestones()">
                <i class="fas fa-flag mr-1"></i>Milestones
            </button>
        </div>

        <!-- Gantt Chart Container -->
        <div class="gantt-container">
            <div class="gantt-header">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Project Timeline</h3>
                    <div class="flex space-x-4 text-sm">
                        <span class="flex items-center">
                            <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>On Track
                        </span>
                        <span class="flex items-center">
                            <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>At Risk
                        </span>
                        <span class="flex items-center">
                            <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>Delayed
                        </span>
                        <span class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>Completed
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Timeline Header -->
            <div id="timelineHeader" class="gantt-timeline">
                <!-- Timeline cells will be generated here -->
            </div>
            
            <!-- Gantt Tasks -->
            <div id="ganttTasks">
                <!-- Gantt rows will be generated here -->
            </div>
        </div>

        <!-- Task Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
            <div class="card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Tasks</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalTasks">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <i class="fas fa-tasks text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Completed</p>
                        <p class="text-2xl font-bold text-gray-900" id="completedTasks">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">In Progress</p>
                        <p class="text-2xl font-bold text-gray-900" id="inProgressTasks">0</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <i class="fas fa-spinner text-yellow-600"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">At Risk</p>
                        <p class="text-2xl font-bold text-gray-900" id="atRiskTasks">0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Task Details</h3>
                <button onclick="closeModal('taskModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form onsubmit="saveTask(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Task Name</label>
                    <input type="text" id="taskName" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assignee</label>
                    <input type="text" id="taskAssignee" class="form-input" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="taskStartDate" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" id="taskEndDate" class="form-input" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Progress (%)</label>
                        <input type="number" id="taskProgress" class="form-input" min="0" max="100" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select id="taskPriority" class="form-input">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="taskStatus" class="form-input">
                        <option value="planned">Planned</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="delayed">Delayed</option>
                    </select>
                </div>
                <button type="submit" class="w-full btn btn-primary">Save Task</button>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="flex items-center">
            <i id="notificationIcon" class="fas fa-check-circle mr-3"></i>
            <div>
                <p id="notificationTitle" class="font-semibold"></p>
                <p id="notificationMessage" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <script>
        // Data Management
        let projects = JSON.parse(localStorage.getItem('projects') || '[]');
        let ganttData = JSON.parse(localStorage.getItem('ganttData') || '{}');
        let currentProject = null;
        let currentView = 'month';
        let showCriticalPath = false;
        let showMilestones = true;
        let draggedTask = null;

        // Initialize Gantt data if empty
        if (Object.keys(ganttData).length === 0) {
            ganttData = {
                1: {
                    tasks: [
                        {
                            id: 1,
                            name: "Requirements Analysis",
                            assignee: "Sarah Johnson",
                            startDate: "2024-01-01",
                            endDate: "2024-01-15",
                            progress: 100,
                            priority: "high",
                            status: "completed",
                            dependencies: []
                        },
                        {
                            id: 2,
                            name: "System Design",
                            assignee: "Mike Chen",
                            startDate: "2024-01-16",
                            endDate: "2024-02-01",
                            progress: 85,
                            priority: "high",
                            status: "in-progress",
                            dependencies: [1]
                        },
                        {
                            id: 3,
                            name: "Development Phase 1",
                            assignee: "Dev Team",
                            startDate: "2024-02-02",
                            endDate: "2024-03-01",
                            progress: 60,
                            priority: "high",
                            status: "in-progress",
                            dependencies: [2]
                        },
                        {
                            id: 4,
                            name: "Testing",
                            assignee: "QA Team",
                            startDate: "2024-03-02",
                            endDate: "2024-03-20",
                            progress: 25,
                            priority: "medium",
                            status: "planned",
                            dependencies: [3]
                        },
                        {
                            id: 5,
                            name: "Deployment",
                            assignee: "Ops Team",
                            startDate: "2024-03-21",
                            endDate: "2024-03-31",
                            progress: 0,
                            priority: "high",
                            status: "planned",
                            dependencies: [4]
                        }
                    ],
                    milestones: [
                        { id: 1, name: "Design Complete", date: "2024-02-01" },
                        { id: 2, name: "Beta Release", date: "2024-03-15" }
                    ]
                }
            };
            saveGanttData();
        }

        function saveGanttData() {
            localStorage.setItem('ganttData', JSON.stringify(ganttData));
        }

        // Load Projects
        function loadProjects() {
            const selector = document.getElementById('projectSelector');
            selector.innerHTML = '<option value="">Choose a project...</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                selector.appendChild(option);
            });
        }

        // Load Project Gantt
        function loadProject() {
            const projectId = parseInt(document.getElementById('projectSelector').value);
            if (!projectId) {
                currentProject = null;
                clearGantt();
                return;
            }

            currentProject = projects.find(p => p.id === projectId);
            if (currentProject) {
                renderGanttChart();
                updateStatistics();
            }
        }

        // Clear Gantt
        function clearGantt() {
            document.getElementById('timelineHeader').innerHTML = '';
            document.getElementById('ganttTasks').innerHTML = '';
            document.getElementById('totalTasks').textContent = '0';
            document.getElementById('completedTasks').textContent = '0';
            document.getElementById('inProgressTasks').textContent = '0';
            document.getElementById('atRiskTasks').textContent = '0';
        }

        // Render Gantt Chart
        function renderGanttChart() {
            if (!currentProject) return;

            const projectData = ganttData[currentProject.id] || { tasks: [], milestones: [] };
            const tasks = projectData.tasks;

            // Generate timeline
            generateTimeline();

            // Render tasks
            renderTasks(tasks);

            // Render today line
            renderTodayLine();
        }

        // Generate Timeline
        function generateTimeline() {
            const header = document.getElementById('timelineHeader');
            header.innerHTML = '';

            const today = new Date();
            let startDate = new Date(today);
            let endDate = new Date(today);

            switch(currentView) {
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 3, 0);
                    break;
                case 'quarter':
                    startDate = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                    endDate = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3 + 4, 0);
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }

            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const cellWidth = 100 / daysDiff;

            for (let i = 0; i <= daysDiff; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const cell = document.createElement('div');
                cell.className = 'gantt-timeline-cell';
                cell.style.width = `${cellWidth}%`;
                cell.textContent = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                    cell.style.background = '#fef2f2';
                }
                
                header.appendChild(cell);
            }
        }

        // Render Tasks
        function renderTasks(tasks) {
            const container = document.getElementById('ganttTasks');
            container.innerHTML = '';

            const timelineCells = document.querySelectorAll('.gantt-timeline-cell');
            const cellWidth = timelineCells.length > 0 ? 100 / timelineCells.length : 0;

            const firstCell = timelineCells[0];
            const startDate = firstCell ? new Date(firstCell.textContent + ', 2024') : new Date();

            tasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'gantt-row';

                // Task info
                const taskInfo = document.createElement('div');
                taskInfo.className = 'gantt-task-info';
                taskInfo.innerHTML = `
                    <div class="font-semibold text-gray-900">${task.name}</div>
                    <div class="text-sm text-gray-600">${task.assignee}</div>
                    <div class="text-xs text-gray-500">${task.progress}% complete</div>
                `;

                // Timeline area
                const timelineArea = document.createElement('div');
                timelineArea.className = 'gantt-timeline-area';
                timelineArea.style.position = 'relative';

                // Calculate task bar position and width
                const taskStart = new Date(task.startDate);
                const taskEnd = new Date(task.endDate);
                const daysDiff = Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) + 1;
                const startDiff = Math.ceil((taskStart - startDate) / (1000 * 60 * 60 * 24));
                
                const left = Math.max(0, startDiff * cellWidth);
                const width = daysDiff * cellWidth;

                // Task bar
                const taskBar = document.createElement('div');
                taskBar.className = `gantt-bar ${getTaskStatusClass(task)}`;
                taskBar.style.left = `${left}%`;
                taskBar.style.width = `${width}%`;
                taskBar.textContent = `${task.name} (${task.progress}%)`;
                taskBar.draggable = true;
                
                taskBar.dataset.taskId = task.id;
                taskBar.onclick = () => editTask(task);
                taskBar.ondragstart = (e) => handleDragStart(e, task);
                taskBar.ondragover = handleDragOver;
                taskBar.ondrop = (e) => handleDrop(e, task);

                timelineArea.appendChild(taskBar);
                row.appendChild(taskInfo);
                row.appendChild(timelineArea);
                container.appendChild(row);
            });
        }

        // Get Task Status Class
        function getTaskStatusClass(task) {
            switch(task.status) {
                case 'completed': return 'completed';
                case 'delayed': return 'delayed';
                case 'in-progress':
                    return task.progress < 30 ? 'at-risk' : '';
                default:
                    return '';
            }
        }

        // Drag and Drop
        function handleDragStart(e, task) {
            draggedTask = task;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e, targetTask) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedTask && draggedTask.id !== targetTask.id) {
                // Simple rescheduling logic
                const daysToMove = 7; // Move by 1 week
                const newStartDate = new Date(draggedTask.startDate);
                newStartDate.setDate(newStartDate.getDate() + daysToMove);
                
                const newEndDate = new Date(draggedTask.endDate);
                newEndDate.setDate(newEndDate.getDate() + daysToMove);

                draggedTask.startDate = newStartDate.toISOString().split('T')[0];
                draggedTask.endDate = newEndDate.toISOString().split('T')[0];

                saveGanttData();
                renderGanttChart();
                showNotification('Task Rescheduled', `${draggedTask.name} moved by ${daysToMove} days`, 'success');
            }

            return false;
        }

        // Render Today Line
        function renderTodayLine() {
            const timelineCells = document.querySelectorAll('.gantt-timeline-cell');
            if (timelineCells.length === 0) return;

            const today = new Date();
            const firstCell = timelineCells[0];
            const startDate = new Date(firstCell.textContent + ', 2024');
            const daysDiff = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));

            if (daysDiff >= 0 && daysDiff < timelineCells.length) {
                const cellWidth = 100 / timelineCells.length;
                const left = daysDiff * cellWidth;

                const todayLine = document.createElement('div');
                todayLine.className = 'today-line';
                todayLine.style.left = `${left}%`;

                const todayLabel = document.createElement('div');
                todayLabel.className = 'today-label';
                todayLabel.textContent = 'TODAY';

                todayLine.appendChild(todayLabel);
                document.querySelector('.gantt-timeline-area').appendChild(todayLine);
            }
        }

        // Update Statistics
        function updateStatistics() {
            if (!currentProject) return;

            const projectData = ganttData[currentProject.id] || { tasks: [] };
            const tasks = projectData.tasks;

            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const inProgress = tasks.filter(t => t.status === 'in-progress').length;
            const atRisk = tasks.filter(t => t.status === 'delayed' || (t.status === 'in-progress' && t.progress < 30)).length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('atRiskTasks').textContent = atRisk;
        }

        // View Controls
        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentProject) {
                renderGanttChart();
            }
        }

        function toggleCriticalPath() {
            showCriticalPath = !showCriticalPath;
            event.target.classList.toggle('active');
            showNotification('Critical Path', showCriticalPath ? 'Critical path enabled' : 'Critical path disabled', 'info');
        }

        function toggleMilestones() {
            showMilestones = !showMilestones;
            event.target.classList.toggle('active');
            showNotification('Milestones', showMilestones ? 'Milestones shown' : 'Milestones hidden', 'info');
        }

        // Task Management
        function showTaskModal() {
            if (!currentProject) {
                showNotification('Error', 'Please select a project first', 'error');
                return;
            }
            document.getElementById('taskModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function editTask(task) {
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskAssignee').value = task.assignee;
            document.getElementById('taskStartDate').value = task.startDate;
            document.getElementById('taskEndDate').value = task.endDate;
            document.getElementById('taskProgress').value = task.progress;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            
            document.getElementById('taskModal').classList.add('active');
            
            // Store current task for editing
            localStorage.setItem('editingTask', JSON.stringify(task));
        }

        function saveTask(event) {
            event.preventDefault();
            
            const editingTask = JSON.parse(localStorage.getItem('editingTask') || 'null');
            const projectData = ganttData[currentProject.id] || { tasks: [], milestones: [] };
            
            const taskData = {
                name: document.getElementById('taskName').value,
                assignee: document.getElementById('taskAssignee').value,
                startDate: document.getElementById('taskStartDate').value,
                endDate: document.getElementById('taskEndDate').value,
                progress: parseInt(document.getElementById('taskProgress').value),
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value
            };

            if (editingTask) {
                // Update existing task
                const taskIndex = projectData.tasks.findIndex(t => t.id === editingTask.id);
                if (taskIndex !== -1) {
                    projectData.tasks[taskIndex] = { ...editingTask, ...taskData };
                }
            } else {
                // Create new task
                const newTask = {
                    id: Date.now(),
                    ...taskData,
                    dependencies: []
                };
                projectData.tasks.push(newTask);
            }

            ganttData[currentProject.id] = projectData;
            saveGanttData();
            renderGanttChart();
            updateStatistics();
            closeModal('taskModal');
            showNotification('Success', editingTask ? 'Task updated successfully!' : 'Task created successfully!', 'success');
            
            // Clear editing task
            localStorage.removeItem('editingTask');
            event.target.reset();
        }

        // Export Gantt
        function exportGantt() {
            if (!currentProject) {
                showNotification('Error', 'Please select a project first', 'error');
                return;
            }

            const projectData = ganttData[currentProject.id];
            const csvContent = generateGanttCSV(projectData);
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name}_gantt.csv`;
            a.click();
            
            showNotification('Export Success', 'Gantt chart exported successfully!', 'success');
        }

        function generateGanttCSV(projectData) {
            let csv = 'Task Name,Assignee,Start Date,End Date,Progress,Status,Priority\n';
            
            projectData.tasks.forEach(task => {
                csv += `"${task.name}","${task.assignee}","${task.startDate}","${task.endDate}",${task.progress},"${task.status}","${task.priority}"\n`;
            });
            
            return csv;
        }

        // Navigation
        function navigateTo(page) {
            const urls = {
                dashboard: 'dashboard-working.html',
                projects: 'project-management-working.html',
                gantt: 'gantt-chart-working-new.html',
                resources: 'resource-allocation-working.html',
                risks: 'raid-management-working.html',
                reports: 'reports-working.html',
                ai: 'ai-analysis-working.html'
            };
            
            if (urls[page]) {
                showNotification('Navigation', `Loading ${page}...`, 'info');
                setTimeout(() => {
                    window.location.href = urls[page];
                }, 1000);
            }
        }

        // Notification System
        function showNotification(title, message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            
            notification.className = `notification ${type}`;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle mr-3 text-green-600';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle mr-3 text-red-600';
            } else {
                icon.className = 'fas fa-info-circle mr-3 text-blue-600';
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Logout
        function logout() {
            showNotification('Logging Out', 'Redirecting to login page...', 'info');
            setTimeout(() => {
                window.location.href = 'index-working.html';
            }, 1500);
        }

        // Initialize
        function init() {
            loadProjects();
            clearGantt();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>